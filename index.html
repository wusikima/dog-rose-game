<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Dog Rose Game - Mobile</title>
  <style>
    * {
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: linear-gradient(180deg, #87CEEB 0%, #98E4D6 100%);
      height: 100vh;
      height: 100dvh; /* Dynamic viewport height for mobile */
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      display: flex;
      flex-direction: column;
      position: fixed;
      width: 100%;
      top: 0;
      left: 0;
    }

    button {
  -webkit-user-select: none;
  -ms-touch-action: manipulation;
  touch-action: manipulation; /* prevents double-tap zoom on mobile */
}

    #gameArea {
      position: relative;
      flex: 1;
      width: 100%;
      overflow: hidden;
      touch-action: none;
    }

.dog {
  position: absolute;
  left: 50%;
  width: min(16vw, 80px); /* larger dog */
  height: auto;
  transform: translateX(-50%);
  z-index: 10;
  filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
  transition: transform 0.1s ease;
}

    .dog.jumping {
      transform: translateX(-50%) scale(1.1);
      animation: jump 0.3s ease-out;
    }

    .petal {
      position: absolute;
      width: min(4vw, 20px);
      height: min(2.5vw, 12px);
      background: radial-gradient(ellipse at center, #FFB6C1, #FF69B4);
      border-radius: 50%;
      opacity: 0.9;
      filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.2));
    }

    #rose {
      position: absolute;
      top: min(2vh, 20px);
      left: 50%;
      transform: translateX(-50%);
      display: grid;
      grid-template-columns: repeat(7, min(3vw, 15px));
      grid-auto-rows: min(3vw, 15px);
      gap: min(0.5vw, 3px);
      z-index: 1000;
      background: rgba(255,255,255,0.1);
      padding: min(2vw, 10px);
      border-radius: min(2vw, 10px);
      backdrop-filter: blur(5px);
    }

    .rose-block {
      width: 100%;
      height: 100%;
      background: rgba(200,200,200,0.5);
      border-radius: 50%;
      transition: all 0.3s ease;
    }

    .rose-block.filled {
      background: radial-gradient(circle, #FF1493, #DC143C);
      transform: scale(1.1);
      box-shadow: 0 0 min(2vw, 10px) rgba(255,20,147,0.5);
    }

#message {
  position: absolute;
  top: 15%; /* higher on screen */
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: rgba(255,255,255,0.9);
  padding: 30px 40px; /* more room for big image */
  border-radius: 20px;
  backdrop-filter: blur(10px);
  z-index: 2000;
}

#message img {
  width: 400px;  /* large PNG */
  height: 400px;
  object-fit: contain;
  margin-bottom: 20px;
}

#message div {
  font-size: 32px; /* fixed pixel size for text */
  font-weight: bold;
  color: #cc6666;
  text-align: center;
}


    /* Mobile-optimized controls */
.controls {
  position: absolute;
  bottom: 0;
  width: 100%;
  height: 20vh; /* use viewport height */
  display: flex;
  align-items: center;
  justify-content: space-around; /* automatically spaces buttons evenly */
  padding: 0 5vw; /* horizontal padding based on viewport width */
  background: rgba(255,255,255,0.1);
  backdrop-filter: blur(10px);
  pointer-events: none;
}

    .btn {
      width: min(15vw, 80px);
      height: min(15vw, 80px);
      border-radius: 50%;
      background: linear-gradient(145deg, #FF6B6B, #FF4757);
      font-size: min(6vw, 30px);
      font-weight: bold;
      border: none;
      box-shadow: 0 min(1vw, 6px) min(2vw, 12px) rgba(0,0,0,0.3);
      pointer-events: auto;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.1s ease;
      cursor: pointer;
    }

    .btn:active {
      background: linear-gradient(145deg, #FF4757, #FF3742);
      transform: translateY(min(0.5vw, 3px));
      box-shadow: 0 min(0.5vw, 3px) min(1vw, 6px) rgba(0,0,0,0.3);
    }

    #jump {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(145deg, #4ECDC4, #44A08D);
    }

    #jump:active {
      background: linear-gradient(145deg, #44A08D, #3A8B7A);
    }

    /* Score display */
    #score {
      position: absolute;
      top: min(2vh, 15px);
      right: min(4vw, 20px);
      font-size: min(4vw, 20px);
      font-weight: bold;
      color: white;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
      background: rgba(0,0,0,0.3);
      padding: min(2vw, 8px) min(3vw, 12px);
      border-radius: min(4vw, 20px);
      backdrop-filter: blur(5px);
    }

    /* Responsive adjustments */
    @media (max-width: 480px) {
      .dog {
        font-size: 50px;
      }
      
      .controls {
        height: 100px;
      }
      
      .btn {
        width: 70px;
        height: 70px;
        font-size: 25px;
      }
    }

    @media (max-height: 600px) {
      #rose {
        top: 10px;
        grid-template-columns: repeat(7, 12px);
        grid-auto-rows: 12px;
        gap: 2px;
        padding: 8px;
      }
      
      .controls {
        height: 80px;
      }
    }

    /* Prevent scrolling and zooming */
    html {
      position: fixed;
      height: 100%;
      overflow: hidden;
    }

    /* Loading animation */
    .petal-enter {
      animation: petalDrop 0.5s ease-out;
    }

    @keyframes petalDrop {
      from {
        opacity: 0;
        transform: scale(0) rotate(0deg);
      }
      to {
        opacity: 0.9;
        transform: scale(1) rotate(180deg);
      }
    }

    /* Jump animation */
    @keyframes jump {
      0% { transform: translateX(-50%) scale(1); }
      50% { transform: translateX(-50%) scale(1.2) rotate(5deg); }
      100% { transform: translateX(-50%) scale(1); }
    }

    .dog.jumping {
      animation: jump 0.3s ease-out;
    }
  </style>
</head>
<body>

  <div id="gameArea">
    <img id="dog" class="dog" src="dog.png" alt="Dog">
    <div id="rose"></div>
    <div id="score">Score: 0</div>
    <div id="message">
  <img id="message-img" src="flower.png" alt="Figure" style="display:none; max-width:500px; margin-bottom:10px;">
  <div id="message-text"></div>
</div>
  </div>

  <div class="controls">
    <button class="btn" id="left">⬅</button>
    <button class="btn" id="jump">⬆</button>
    <button class="btn" id="right">➡</button>
  </div>

  <script>
    // Prevent default touch behaviors
    document.addEventListener('touchstart', e => e.preventDefault(), { passive: false });
    document.addEventListener('touchmove', e => e.preventDefault(), { passive: false });
    document.addEventListener('touchend', e => e.preventDefault(), { passive: false });

    // Prevent zoom on double tap
    let lastTouchEnd = 0;
    document.addEventListener('touchend', e => {
      const now = (new Date()).getTime();
      if (now - lastTouchEnd <= 300) {
        e.preventDefault();
      }
      lastTouchEnd = now;
    }, false);

    const gameArea = document.getElementById("gameArea");
    const dog = document.getElementById("dog");
    const message = document.getElementById("message");
    const roseContainer = document.getElementById("rose");
    const scoreEl = document.getElementById("score");

    let score = 0;
    let gameWidth = window.innerWidth;
    let gameHeight = window.innerHeight;
    let dogX = gameWidth / 2;
    let dogY = gameHeight - 300; 
    let dx = 0;
    let dy = 0;
    let jumping = false;
    let gameRunning = true;

    // Responsive sizing
    function updateGameDimensions() {
      gameWidth = window.innerWidth;
      gameHeight = window.innerHeight;
      dogY = Math.min(dogY, gameHeight - 160);
      dogX = Math.max(0, Math.min(dogX, gameWidth - 50));
    }

    window.addEventListener('resize', updateGameDimensions);
    window.addEventListener('orientationchange', () => {
      setTimeout(updateGameDimensions, 100);
    });

    dog.style.left = dogX + "px";
    dog.style.top = dogY + "px";

    // Rose pattern
    const rosePattern = [
      [0,0,1,0,1,0,0],
      [0,1,1,1,1,1,0],
      [1,1,1,1,1,1,1],
      [0,1,1,1,1,1,0],
      [0,0,1,1,1,0,0]
    ];

    const roseBlocks = [];
    rosePattern.forEach(row => {
      row.forEach(cell => {
        const block = document.createElement("div");
        block.className = "rose-block";
        if(cell === 1) roseBlocks.push(block);
        roseContainer.appendChild(block);
      });
    });

    let roseIndex = 0;

    // Enhanced touch controls with better feedback
    const leftBtn = document.getElementById("left");
    const rightBtn = document.getElementById("right");
    const jumpBtn = document.getElementById("jump");

    // Touch event handlers with proper passive handling
    function addTouchControls(element, startAction, endAction) {
      let isPressed = false;

      const handleStart = (e) => {
        e.stopPropagation();
        if (!isPressed) {
          isPressed = true;
          startAction();
          navigator.vibrate && navigator.vibrate(50);
        }
      };

      const handleEnd = (e) => {
        e.stopPropagation();
        if (isPressed) {
          isPressed = false;
          endAction && endAction();
        }
      };

      element.addEventListener("touchstart", handleStart, { passive: false });
      element.addEventListener("touchend", handleEnd, { passive: false });
      element.addEventListener("touchcancel", handleEnd, { passive: false });
      
      // Mouse support for testing
      element.addEventListener("mousedown", handleStart);
      element.addEventListener("mouseup", handleEnd);
      element.addEventListener("mouseleave", handleEnd);
    }

    addTouchControls(leftBtn, () => dx = -6, () => dx = 0);
    addTouchControls(rightBtn, () => dx = 6, () => dx = 0);
    addTouchControls(jumpBtn, () => {
      if (!jumping && gameRunning) {
        dy = -14;
        jumping = true;
        dog.classList.add('jumping');
        setTimeout(() => dog.classList.remove('jumping'), 300);
      }
    });

    // Keyboard controls (for testing on desktop)
    document.addEventListener("keydown", e => {
      if (!gameRunning) return;
      if (e.key === "ArrowLeft") dx = -6;
      if (e.key === "ArrowRight") dx = 6;
      if (e.key === " " && !jumping) { 
        e.preventDefault();
        dy = -14; 
        jumping = true; 
        dog.classList.add('jumping');
        setTimeout(() => dog.classList.remove('jumping'), 300);
      }
    });

    document.addEventListener("keyup", e => {
      if (e.key === "ArrowLeft" || e.key === "ArrowRight") dx = 0;
    });

    // Enhanced petal creation with better mobile performance
    function createPetal() {
      if (!gameRunning) return;

      const petal = document.createElement("div");
      petal.className = "petal petal-enter";

      const startX = Math.random() * (gameWidth - 20);
      let top = -20;
      let angle = Math.random() * 2 * Math.PI;
      const amplitude = 15 + Math.random() * 15;
      const speed = 0.04 + Math.random() * 0.02;
      const fallSpeed = 3 + Math.random() * 2;

      petal.style.left = startX + "px";
      petal.style.top = top + "px";
      petal.style.transform = `rotate(${Math.random()*360}deg)`;
      gameArea.appendChild(petal);

      const fall = setInterval(() => {
        top += fallSpeed;
        angle += speed;
        petal.style.top = top + "px";
        petal.style.left = startX + Math.sin(angle) * amplitude + "px";
        petal.style.transform = `rotate(${angle * 57.3}deg)`;

        // Optimized collision detection
        const petalRect = petal.getBoundingClientRect();
        const dogRect = dog.getBoundingClientRect();

        if (
          petalRect.bottom >= dogRect.top + 10 &&
          petalRect.top <= dogRect.bottom - 10 &&
          petalRect.left < dogRect.right - 10 &&
          petalRect.right > dogRect.left + 10
        ) {
          score++;
          scoreEl.textContent = `Score: ${score}`;
          petal.remove();
          clearInterval(fall);

          // Visual feedback
          if (navigator.vibrate) navigator.vibrate(30);

          // Fill rose block with animation
          if (roseIndex < roseBlocks.length) {
            roseBlocks[roseIndex].classList.add("filled");
            roseIndex++;
          }

          // Show completion message
          if (roseIndex >= roseBlocks.length && gameRunning) {
  gameRunning = false;

  const messageImg = document.getElementById("message-img");
  const messageText = document.getElementById("message-text");

  messageImg.style.display = "block"; // show PNG
  messageText.innerHTML = "小狗给你带了一只玫瑰!"; // line below

  message.style.display = "flex";
  message.style.flexDirection = "column";
  message.style.alignItems = "center";
  message.style.justifyContent = "center";

  if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
}
        }

        if (top > gameHeight + 20) {
          petal.remove();
          clearInterval(fall);
        }
      }, 16); // 60fps target
    }

    // Adaptive petal creation rate
    let petalInterval = setInterval(createPetal, 1000);

    // Adjust difficulty over time
    setTimeout(() => {
      clearInterval(petalInterval);
      petalInterval = setInterval(createPetal, 800);
    }, 10000);

    setTimeout(() => {
      clearInterval(petalInterval);
      petalInterval = setInterval(createPetal, 600);
    }, 30000);

    function update() {
      if (!gameRunning) return;

      dogX += dx;
      dogY += dy;
      dy += 0.7; // slightly stronger gravity for mobile

      const ground = gameHeight - 200;
      if(dogY >= ground) { 
        dogY = ground; 
        dy = 0; 
        jumping = false; 
      }

      // Screen boundary constraints
      const dogWidth = 50;
      if(dogX < dogWidth/2) dogX = dogWidth/2;
      if(dogX > gameWidth - dogWidth/2) dogX = gameWidth - dogWidth/2;

      dog.style.left = dogX + "px";
      dog.style.top = dogY + "px";

      requestAnimationFrame(update);
    }

    // Start the game
    updateGameDimensions();
    update();

    // Performance monitoring
    let lastFrame = performance.now();
    function checkPerformance() {
      const now = performance.now();
      const delta = now - lastFrame;
      if (delta > 32) { // If frame rate drops below 30fps
        // Reduce visual effects
        document.querySelectorAll('.petal').forEach(p => {
          p.style.filter = 'none';
        });
      }
      lastFrame = now;
      requestAnimationFrame(checkPerformance);
    }
    checkPerformance();
  </script>
</body>
</html>